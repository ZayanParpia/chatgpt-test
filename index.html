#NEW CODE

package com.example.obstrue

import android.content.Intent
import android.graphics.BitmapFactory
import android.media.AudioAttributes
import android.media.MediaPlayer
import android.net.Uri
import android.provider.OpenableColumns
import android.widget.Toast
import androidx.activity.compose.rememberLauncherForActivityResult
import androidx.activity.result.contract.ActivityResultContracts
import androidx.compose.animation.core.animateFloatAsState
import androidx.compose.foundation.Image
import androidx.compose.foundation.background
import androidx.compose.foundation.border
import androidx.compose.foundation.clickable
import androidx.compose.foundation.interaction.MutableInteractionSource
import androidx.compose.foundation.layout.*
import androidx.compose.foundation.rememberScrollState
import androidx.compose.foundation.shape.CircleShape
import androidx.compose.foundation.shape.RoundedCornerShape
import androidx.compose.foundation.text.BasicTextField
import androidx.compose.foundation.verticalScroll
import androidx.compose.material3.*
import androidx.compose.runtime.*
import androidx.compose.runtime.saveable.rememberSaveable
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.draw.scale
import androidx.compose.ui.graphics.Brush
import androidx.compose.ui.graphics.Color
import androidx.compose.ui.graphics.ImageBitmap
import androidx.compose.ui.graphics.SolidColor
import androidx.compose.ui.graphics.asImageBitmap
import androidx.compose.ui.layout.ContentScale
import androidx.compose.ui.platform.LocalConfiguration
import androidx.compose.ui.platform.LocalContext
import androidx.compose.ui.platform.LocalLifecycleOwner
import androidx.compose.ui.res.painterResource
import androidx.compose.ui.text.TextStyle
import androidx.compose.ui.text.font.FontWeight
import androidx.compose.ui.text.style.TextOverflow
import androidx.compose.ui.unit.Dp
import androidx.compose.ui.unit.dp
import androidx.compose.ui.unit.sp
import androidx.lifecycle.DefaultLifecycleObserver
import androidx.lifecycle.LifecycleOwner
import androidx.navigation.NavHostController
import androidx.navigation.navOptions
import androidx.navigation.compose.currentBackStackEntryAsState
import kotlinx.coroutines.delay
import java.io.File
import java.io.FileOutputStream
import java.io.InputStream

/**
 * MsgVoicesScreen.kt
 *
 * - Sound label + switch are on the same row and placed ABOVE the sound section (upload/play).
 * - Jumpscares label + switch are on the same row and placed ABOVE the jumpscare card.
 * - Main and jumpscare play/pause use the same icons and size.
 * - Jumpscare sound slider is interactive and seeks while playing.
 * - Persistent prefs for toggles, selected URIs, and play flags.
 * - Bottom nav item for current page is disabled.
 *
 * Replace resource ids (R.drawable.* / R.raw.*) with your project's assets.
 */

@Composable
fun MsgVoicesScreen(navController: NavHostController) {
    val context = LocalContext.current
    val prefs = remember { context.getSharedPreferences("obstrue_prefs", android.content.Context.MODE_PRIVATE) }

    // ---------- Persisted/UI State ----------
    var isSoundOn by rememberSaveable { mutableStateOf(prefs.getBoolean("saved_sound_on", true)) }
    var message by rememberSaveable { mutableStateOf(prefs.getString("saved_message", "") ?: "") }
    var selectedFileUriStr by rememberSaveable { mutableStateOf(prefs.getString("saved_video_uri", null)) }
    var selectedFileName by rememberSaveable { mutableStateOf(prefs.getString("saved_video_name", null)) }
    val selectedFileUri: Uri? = selectedFileUriStr?.let { Uri.parse(it) }

    var jumpscaresOn by rememberSaveable { mutableStateOf(prefs.getBoolean("saved_jumpscares_on", false)) }
    var jumpscareSelectedIndex by rememberSaveable { mutableStateOf(prefs.getInt("saved_jumpscare_index", 0)) }
    var jumpscareCustomUriStr by rememberSaveable { mutableStateOf(prefs.getString("saved_jumpscare_custom_uri", null)) }
    val jumpscareCustomUri: Uri? = jumpscareCustomUriStr?.let { Uri.parse(it) }
    var jumpscareCustomBitmap by remember { mutableStateOf<ImageBitmap?>(null) }

    // Main media player (prepared on demand)
    var mediaPlayer by remember { mutableStateOf<MediaPlayer?>(null) }
    var durationMs by remember { mutableStateOf(0) }
    var currentPositionMs by remember { mutableStateOf(0) }
    var isPlaying by remember { mutableStateOf(prefs.getBoolean("saved_is_playing", false)) }
    var isSeeking by remember { mutableStateOf(false) }
    var seekPercent by remember { mutableStateOf(0f) }

    // Random/sample
    var randomOn by rememberSaveable { mutableStateOf(prefs.getBoolean("saved_random_on", false)) }
    val randomScale by animateFloatAsState(if (randomOn) 1.06f else 1f)

    // Jumpscare sound
    var jumpscareSoundSelectedIndex by rememberSaveable { mutableStateOf(prefs.getInt("saved_jumpscare_sound_index", 0)) }
    var jumpscareSoundPlayer by remember { mutableStateOf<MediaPlayer?>(null) }
    var jumpscareSoundDurationMs by remember { mutableStateOf(0) }
    var jumpscareSoundCurrentMs by remember { mutableStateOf(0) }
    var jumpscareSoundIsPlaying by remember { mutableStateOf(prefs.getBoolean("saved_jumpscare_is_playing", false)) }

    var showPermissionDialog by remember { mutableStateOf(false) }

    val noRipple = remember { MutableInteractionSource() }

    // ---------- Helpers ----------
    fun resolveDisplayName(uri: Uri?): String? {
        uri ?: return null
        val resolver = context.contentResolver
        val projection = arrayOf(OpenableColumns.DISPLAY_NAME)
        resolver.query(uri, projection, null, null, null)?.use { cursor ->
            if (cursor.moveToFirst()) {
                val idx = cursor.getColumnIndex(OpenableColumns.DISPLAY_NAME)
                if (idx >= 0) return cursor.getString(idx)
            }
        }
        return uri.lastPathSegment
    }

    fun loadBitmapFromUri(uri: Uri?): ImageBitmap? {
        uri ?: return null
        return try {
            context.contentResolver.openInputStream(uri)?.use {
                BitmapFactory.decodeStream(it)?.asImageBitmap()
            }
        } catch (_: Exception) {
            null
        }
    }

    fun fallbackCopyToCacheAndPrepare(uri: Uri, targetForMain: Boolean = true): MediaPlayer? {
        try {
            context.contentResolver.openInputStream(uri)?.use { input ->
                val temp = File(context.cacheDir, "obstrue_tmp_${System.currentTimeMillis()}.mp4")
                FileOutputStream(temp).use { out -> input.copyTo(out) }
                val mp = MediaPlayer().apply {
                    setAudioAttributes(
                        AudioAttributes.Builder()
                            .setUsage(AudioAttributes.USAGE_MEDIA)
                            .setContentType(AudioAttributes.CONTENT_TYPE_MUSIC)
                            .build()
                    )
                    setDataSource(temp.absolutePath)
                    prepareAsync()
                    setOnPreparedListener { player ->
                        if (targetForMain) durationMs = try { player.duration } catch (_: Exception) { 0 }
                        else jumpscareSoundDurationMs = try { player.duration } catch (_: Exception) { 0 }
                    }
                    setOnCompletionListener {
                        try { it.seekTo(0) } catch (_: Exception) {}
                        if (targetForMain) isPlaying = false else jumpscareSoundIsPlaying = false
                    }
                }
                return mp
            } ?: run {
                Toast.makeText(context, "Unable to open file", Toast.LENGTH_SHORT).show()
            }
        } catch (e: Exception) {
            Toast.makeText(context, "Fallback failed: ${e.message}", Toast.LENGTH_LONG).show()
        }
        return null
    }

    fun prepareMediaFromUri(localContext: android.content.Context, uri: Uri, forJumpscareSound: Boolean = false): MediaPlayer? {
        return try {
            localContext.contentResolver.openFileDescriptor(uri, "r")?.use { pfd ->
                val mp = MediaPlayer().apply {
                    setAudioAttributes(
                        AudioAttributes.Builder()
                            .setUsage(AudioAttributes.USAGE_MEDIA)
                            .setContentType(AudioAttributes.CONTENT_TYPE_MUSIC)
                            .build()
                    )
                    setDataSource(pfd.fileDescriptor)
                    prepareAsync()
                    setOnPreparedListener { player ->
                        if (forJumpscareSound) jumpscareSoundDurationMs = try { player.duration } catch (_: Exception) { 0 }
                        else durationMs = try { player.duration } catch (_: Exception) { 0 }
                    }
                    setOnCompletionListener {
                        try { it.seekTo(0) } catch (_: Exception) {}
                        if (forJumpscareSound) jumpscareSoundIsPlaying = false else isPlaying = false
                    }
                }
                mp
            } ?: fallbackCopyToCacheAndPrepare(uri, targetForMain = !forJumpscareSound)
        } catch (se: SecurityException) {
            Toast.makeText(localContext, "Permission denied", Toast.LENGTH_LONG).show()
            fallbackCopyToCacheAndPrepare(uri, targetForMain = !forJumpscareSound)
        } catch (e: Exception) {
            Toast.makeText(localContext, "Can't play selected file: ${e.message}", Toast.LENGTH_SHORT).show()
            fallbackCopyToCacheAndPrepare(uri, targetForMain = !forJumpscareSound)
        }
    }

    fun prepareMediaFromRes(resId: Int, forJumpscareSound: Boolean = false): MediaPlayer? {
        return try {
            val mp = MediaPlayer.create(context, resId)
            mp?.setAudioAttributes(
                AudioAttributes.Builder()
                    .setUsage(AudioAttributes.USAGE_MEDIA)
                    .setContentType(AudioAttributes.CONTENT_TYPE_MUSIC)
                    .build()
            )
            mp?.setOnCompletionListener {
                try { it.seekTo(0) } catch (_: Exception) {}
                if (forJumpscareSound) jumpscareSoundIsPlaying = false else isPlaying = false
            }
            mp?.let {
                if (forJumpscareSound) jumpscareSoundDurationMs = try { it.duration } catch (_: Exception) { 0 }
                else durationMs = try { it.duration } catch (_: Exception) { 0 }
            }
            mp
        } catch (e: Exception) {
            Toast.makeText(context, "Can't load resource: ${e.message}", Toast.LENGTH_SHORT).show()
            null
        }
    }

    fun releaseJumpscareSoundPlayer() {
        try {
            jumpscareSoundPlayer?.let { p ->
                try { if (p.isPlaying) p.stop() } catch (_: Exception) {}
                try { p.release() } catch (_: Exception) {}
            }
        } catch (_: Exception) {}
        jumpscareSoundPlayer = null
        jumpscareSoundDurationMs = 0
        jumpscareSoundCurrentMs = 0
        jumpscareSoundIsPlaying = false
        prefs.edit().putBoolean("saved_jumpscare_is_playing", false).apply()
    }

    // ---------- Lifecycle handling ----------
    val lifecycleOwner = LocalLifecycleOwner.current
    DisposableEffect(lifecycleOwner) {
        val observer = object : DefaultLifecycleObserver {
            override fun onPause(owner: LifecycleOwner) {
                try { mediaPlayer?.pause() } catch (_: Exception) {}
                isPlaying = false
                try { jumpscareSoundPlayer?.pause() } catch (_: Exception) {}
                jumpscareSoundIsPlaying = false
            }
            override fun onDestroy(owner: LifecycleOwner) {
                try { mediaPlayer?.release() } catch (_: Exception) {}
                mediaPlayer = null; isPlaying = false
                releaseJumpscareSoundPlayer()
            }
        }
        lifecycleOwner.lifecycle.addObserver(observer)
        onDispose {
            lifecycleOwner.lifecycle.removeObserver(observer)
            try { mediaPlayer?.release() } catch (_: Exception) {}
            mediaPlayer = null; isPlaying = false
            releaseJumpscareSoundPlayer()
        }
    }

    // ---------- Activity Result Launchers ----------
    val openDocumentLauncher = rememberLauncherForActivityResult(ActivityResultContracts.OpenDocument()) { uri: Uri? ->
        if (jumpscaresOn) {
            Toast.makeText(context, "Disable jumpscares first", Toast.LENGTH_SHORT).show()
            return@rememberLauncherForActivityResult
        }
        uri?.let { pickedUri ->
            selectedFileUriStr = pickedUri.toString()
            selectedFileName = resolveDisplayName(pickedUri)
            try { context.contentResolver.takePersistableUriPermission(pickedUri, Intent.FLAG_GRANT_READ_URI_PERMISSION) } catch (_: Exception) {}
            prefs.edit().putString("saved_video_uri", selectedFileUriStr).apply()
            prefs.edit().putString("saved_video_name", selectedFileName).apply()
            // prepare but don't auto-start (user explicitly plays)
            prepareMediaFromUri(context, pickedUri, forJumpscareSound = false)?.let { mp ->
                mediaPlayer?.release()
                mediaPlayer = mp
                isPlaying = false
                prefs.edit().putBoolean("saved_is_playing", false).apply()
            }
        }
    }

    val openImageLauncher = rememberLauncherForActivityResult(ActivityResultContracts.OpenDocument()) { uri: Uri? ->
        uri?.let { pickedUri ->
            if (!jumpscaresOn) {
                Toast.makeText(context, "Enable jumpscares to change images", Toast.LENGTH_SHORT).show()
                return@rememberLauncherForActivityResult
            }
            jumpscareCustomUriStr = pickedUri.toString()
            jumpscareCustomBitmap = loadBitmapFromUri(pickedUri)
            try { context.contentResolver.takePersistableUriPermission(pickedUri, Intent.FLAG_GRANT_READ_URI_PERMISSION) } catch (_: Exception) {}
            prefs.edit().putString("saved_jumpscare_custom_uri", jumpscareCustomUriStr).apply()
        }
    }

    // ---------- Progress updaters ----------
    LaunchedEffect(mediaPlayer) {
        while (mediaPlayer != null) {
            val mp = mediaPlayer
            if (mp != null) {
                try {
                    val dur = if (durationMs > 0) durationMs else try { mp.duration } catch (_: Exception) { 0 }
                    if (dur > 0) durationMs = dur
                    val cur = try { mp.currentPosition } catch (_: Exception) { 0 }
                    currentPositionMs = cur
                    if (!isSeeking && durationMs > 0) seekPercent = (currentPositionMs.toFloat() / durationMs.toFloat())
                } catch (_: Exception) {}
            }
            delay(250L)
        }
    }

    LaunchedEffect(jumpscareSoundPlayer) {
        while (jumpscareSoundPlayer != null) {
            val mp = jumpscareSoundPlayer
            if (mp != null) {
                try {
                    val dur = if (jumpscareSoundDurationMs > 0) jumpscareSoundDurationMs else try { mp.duration } catch (_: Exception) { 0 }
                    if (dur > 0) jumpscareSoundDurationMs = dur
                    val cur = try { mp.currentPosition } catch (_: Exception) { 0 }
                    jumpscareSoundCurrentMs = cur
                } catch (_: Exception) {}
            }
            delay(250L)
        }
    }

    // Persist toggles / message / indices
    LaunchedEffect(isSoundOn) { prefs.edit().putBoolean("saved_sound_on", isSoundOn).apply() }
    LaunchedEffect(jumpscaresOn) { prefs.edit().putBoolean("saved_jumpscares_on", jumpscaresOn).apply() }
    LaunchedEffect(jumpscareSelectedIndex) { prefs.edit().putInt("saved_jumpscare_index", jumpscareSelectedIndex).apply() }
    LaunchedEffect(jumpscareSoundSelectedIndex) { prefs.edit().putInt("saved_jumpscare_sound_index", jumpscareSoundSelectedIndex).apply() }
    LaunchedEffect(randomOn) { prefs.edit().putBoolean("saved_random_on", randomOn).apply() }
    LaunchedEffect(message) { prefs.edit().putString("saved_message", message).apply() }

    // Mutual exclusivity behavior: enabling one disables the other
    LaunchedEffect(isSoundOn) {
        if (isSoundOn && jumpscaresOn) {
            jumpscaresOn = false
            releaseJumpscareSoundPlayer()
            prefs.edit().putBoolean("saved_jumpscares_on", false).apply()
        }
        if (!isSoundOn) {
            try { mediaPlayer?.pause() } catch (_: Exception) {}
            isPlaying = false
            prefs.edit().putBoolean("saved_is_playing", false).apply()
        }
    }
    LaunchedEffect(jumpscaresOn) {
        if (jumpscaresOn && isSoundOn) {
            isSoundOn = false
            try { mediaPlayer?.pause() } catch (_: Exception) {}
            isPlaying = false
            prefs.edit().putBoolean("saved_is_playing", false).apply()
            prefs.edit().putBoolean("saved_sound_on", false).apply()
        }
        if (!jumpscaresOn) {
            releaseJumpscareSoundPlayer()
            prefs.edit().putBoolean("saved_jumpscare_is_playing", false).apply()
        }
    }

    // Restore custom bitmap if saved
    LaunchedEffect(jumpscareCustomUriStr) {
        jumpscareCustomUriStr?.let {
            try {
                val u = Uri.parse(it)
                jumpscareCustomBitmap = loadBitmapFromUri(u)
            } catch (_: Exception) {}
        }
    }

    // Restore main media if persisted; do not auto-start unless user had it playing and allowed
    LaunchedEffect(selectedFileUriStr) {
        selectedFileUriStr?.let { uriStr ->
            try {
                val uri = Uri.parse(uriStr)
                if (mediaPlayer == null) {
                    prepareMediaFromUri(context, uri, forJumpscareSound = false)?.let { mp ->
                        mediaPlayer?.release()
                        mediaPlayer = mp
                        val savedPlay = prefs.getBoolean("saved_is_playing", false)
                        if (savedPlay && isSoundOn) {
                            mediaPlayer?.setOnPreparedListener { player ->
                                durationMs = try { player.duration } catch (_: Exception) { 0 }
                                try { player.start(); isPlaying = true } catch (_: Exception) {}
                            }
                        }
                    }
                }
            } catch (_: Exception) {}
        }
    }

    // Prepare jumpscare sound selection with exhaustive when
    LaunchedEffect(jumpscareSoundSelectedIndex, jumpscareCustomUriStr) {
        if (!jumpscaresOn) return@LaunchedEffect
        when (jumpscareSoundSelectedIndex) {
            0 -> {
                releaseJumpscareSoundPlayer()
                jumpscareSoundPlayer = prepareMediaFromRes(R.raw.scream1, forJumpscareSound = true)
                val saved = prefs.getBoolean("saved_jumpscare_is_playing", false)
                if (saved) {
                    jumpscareSoundPlayer?.setOnPreparedListener { p ->
                        jumpscareSoundDurationMs = try { p.duration } catch (_: Exception) { 0 }
                        try { p.start(); jumpscareSoundIsPlaying = true } catch (_: Exception) {}
                    }
                }
            }
            1 -> {
                releaseJumpscareSoundPlayer()
                jumpscareSoundPlayer = prepareMediaFromRes(R.raw.scream2, forJumpscareSound = true)
                val saved = prefs.getBoolean("saved_jumpscare_is_playing", false)
                if (saved) {
                    jumpscareSoundPlayer?.setOnPreparedListener { p ->
                        jumpscareSoundDurationMs = try { p.duration } catch (_: Exception) { 0 }
                        try { p.start(); jumpscareSoundIsPlaying = true } catch (_: Exception) {}
                    }
                }
            }
            2 -> {
                // custom sound (if present)
                jumpscareCustomUriStr?.let { uriStr ->
                    try {
                        val uri = Uri.parse(uriStr)
                        releaseJumpscareSoundPlayer()
                        jumpscareSoundPlayer = prepareMediaFromUri(context, uri, forJumpscareSound = true)
                        val saved = prefs.getBoolean("saved_jumpscare_is_playing", false)
                        if (saved) {
                            jumpscareSoundPlayer?.setOnPreparedListener { p ->
                                jumpscareSoundDurationMs = try { p.duration } catch (_: Exception) { 0 }
                                try { p.start(); jumpscareSoundIsPlaying = true } catch (_: Exception) {}
                            }
                        }
                    } catch (_: Exception) { releaseJumpscareSoundPlayer() }
                } ?: run { releaseJumpscareSoundPlayer() }
            }
            else -> {
                // exhaustive fallback
                releaseJumpscareSoundPlayer()
            }
        }
    }

    // ---------- UI sizing + layout ----------
    val configuration = LocalConfiguration.current
    Box(
        modifier = Modifier
            .fillMaxSize()
            .background(Color(0xFF0B0710))
    ) {
        BoxWithConstraints(modifier = Modifier.fillMaxSize()) {
            val w = maxWidth.value
            val h = maxHeight.value

            val titleSize = when {
                configuration.screenWidthDp < 360 -> 28.sp
                configuration.screenWidthDp < 420 -> 34.sp
                configuration.screenWidthDp < 600 -> 40.sp
                else -> 48.sp
            }
            val messageFontSize = (w * 0.04f).coerceIn(12f, 20f).sp
            val charCountSize = (w * 0.033f).coerceIn(10f, 14f).sp
            val playSize = (w * 0.11f).coerceIn(36f, 56f).dp
            val bottomBarHeight = (h * 0.11f).coerceIn(72f, 120f).dp
            val uploadIconSize = (w * 0.16f).coerceIn(48f, 120f).dp
            val uploadHeight = (h * 0.12f).coerceIn(64f, 160f).dp
            val messageBoxHeight = (h * 0.33f).coerceIn(200f, 420f).dp
            val topSpacing = (h * 0.05f).coerceIn(24f, 120f).dp
            val sectionSpacing = (h * 0.045f).coerceIn(20f, 72f).dp // slightly larger spacing
            val betweenSpacing = (h * 0.02f).coerceIn(8f, 40f).dp
            val cardColor = Color(0xFF2A1E2B)
            val textBoxColor = Color(0xFF241827)
            val saveGradient = Brush.horizontalGradient(listOf(Color(0xFF7B61FF), Color(0xFFFF69B4)))
            val sectionTitleSize = (w * 0.045f).coerceIn(16f, 22f).sp

            Column(
                modifier = Modifier
                    .fillMaxSize()
                    .verticalScroll(rememberScrollState())
                    .padding(horizontal = (w * 0.05f).coerceIn(12f, 36f).dp)
                    .padding(bottom = (h * 0.12f).coerceIn(90f, 180f).dp),
                horizontalAlignment = Alignment.CenterHorizontally
            ) {
                Spacer(modifier = Modifier.height(topSpacing))

                // Screen title
                Text(
                    text = "Msg & Audios",
                    color = Color(0xFFEFE7F6),
                    fontSize = titleSize,
                    fontWeight = FontWeight.ExtraBold
                )

                Spacer(modifier = Modifier.height(betweenSpacing))

                // Message input area
                Box(
                    modifier = Modifier
                        .fillMaxWidth()
                        .height(messageBoxHeight)
                        .background(if (jumpscaresOn) Color(0xFF2F2F2F) else textBoxColor, RoundedCornerShape(20.dp))
                        .padding((w * 0.04f).coerceIn(10f, 20f).dp)
                ) {
                    Column(modifier = Modifier.fillMaxSize()) {
                        val scroll = rememberScrollState()
                        BasicTextField(
                            value = message,
                            onValueChange = {
                                if (jumpscaresOn) {
                                    Toast.makeText(context, "Disable jumpscares first", Toast.LENGTH_SHORT).show()
                                    return@BasicTextField
                                }
                                if (it.length <= 250) message = it else Toast.makeText(context, "Character limit reached", Toast.LENGTH_SHORT).show()
                            },
                            modifier = Modifier.fillMaxWidth().weight(1f).verticalScroll(scroll),
                            textStyle = TextStyle(color = Color.White, fontSize = messageFontSize),
                            cursorBrush = SolidColor(Color.White)
                        )

                        Spacer(modifier = Modifier.height(8.dp))

                        Row(modifier = Modifier.fillMaxWidth(), verticalAlignment = Alignment.CenterVertically) {
                            Button(
                                onClick = {
                                    if (jumpscaresOn) {
                                        Toast.makeText(context, "Disable jumpscares first", Toast.LENGTH_SHORT).show()
                                        return@Button
                                    }
                                    randomOn = !randomOn
                                    if (randomOn) {
                                        val samples = listOf(
                                            "Stay focused â€” you got this.",
                                            "Remember why you started.",
                                            "One step at a time. Finish the task.",
                                            "Being a loser is hard, getting successful is hard, choose your hard...",
                                            "You waste so much time on your phone..."
                                        )
                                        message = samples.random()
                                    }
                                },
                                modifier = Modifier.scale(randomScale),
                                colors = ButtonDefaults.buttonColors(containerColor = if (randomOn) Color(0xFF20B2AA) else Color(0xFF3C2B3E)),
                                shape = RoundedCornerShape(8.dp)
                            ) {
                                Text(text = if (randomOn) "Random (On)" else "Random", color = Color.White, fontSize = 14.sp)
                            }

                            Spacer(modifier = Modifier.width(8.dp))

                            Button(onClick = { if (!jumpscaresOn) message = "" else Toast.makeText(context, "Disable jumpscares first", Toast.LENGTH_SHORT).show() },
                                colors = ButtonDefaults.buttonColors(containerColor = Color(0xFF3C2B3E)), shape = RoundedCornerShape(8.dp)) {
                                Text("Clear", color = Color.White, fontSize = charCountSize)
                            }

                            Spacer(modifier = Modifier.weight(1f))
                            Text("${message.length}/250", color = Color(0xFFB6A9C1), fontSize = charCountSize)
                        }
                    }
                }

                Spacer(modifier = Modifier.height(sectionSpacing))

                // --------------------
                // SOUND LABEL + SWITCH
                // (on the same row, above the upload / sound controls)
                // --------------------
                Row(
                    modifier = Modifier
                        .fillMaxWidth()
                        .padding(horizontal = 6.dp),
                    verticalAlignment = Alignment.CenterVertically
                ) {
                    Text(text = "Sound", color = Color(0xFFEFE7F6), fontSize = sectionTitleSize, fontWeight = FontWeight.SemiBold)
                    Spacer(modifier = Modifier.weight(1f))
                    Switch(
                        checked = isSoundOn,
                        onCheckedChange = { checked ->
                            isSoundOn = checked
                            prefs.edit().putBoolean("saved_sound_on", isSoundOn).apply()
                            if (checked && jumpscaresOn) {
                                // disable jumpscares when enabling sound
                                jumpscaresOn = false
                                releaseJumpscareSoundPlayer()
                                prefs.edit().putBoolean("saved_jumpscares_on", false).apply()
                            }
                            if (!checked) {
                                try { mediaPlayer?.pause() } catch (_: Exception) {}
                                isPlaying = false
                                prefs.edit().putBoolean("saved_is_playing", false).apply()
                            }
                        },
                        colors = SwitchDefaults.colors(
                            checkedThumbColor = Color.White, checkedTrackColor = Color(0xFF20C997),
                            uncheckedThumbColor = Color.White, uncheckedTrackColor = Color(0xFF7A7A7A)
                        )
                    )
                }

                Spacer(modifier = Modifier.height(8.dp))

                // --------------------
                // UPLOAD / MAIN SOUND CARD
                // (sound controls live inside this card)
                // --------------------
                Box(
                    modifier = Modifier
                        .fillMaxWidth()
                        .background(cardColor, RoundedCornerShape(18.dp))
                        .padding(16.dp)
                ) {
                    Column(horizontalAlignment = Alignment.CenterHorizontally) {
                        // upload area (tappable)
                        Box(
                            modifier = Modifier
                                .fillMaxWidth()
                                .height(uploadHeight)
                                .background(if (jumpscaresOn) Color(0xFF2F2F2F) else Color(0xFF3C2B3E), RoundedCornerShape(14.dp))
                                .clickable(interactionSource = noRipple, indication = null) {
                                    if (!isSoundOn) {
                                        // Even if jumpscares are off, we allow upload only when Sound is ON (you can choose different UX)
                                        showPermissionDialog = true
                                    } else {
                                        showPermissionDialog = true
                                    }
                                },
                            contentAlignment = Alignment.Center
                        ) {
                            Image(painter = painterResource(id = R.drawable.upload), contentDescription = null, modifier = Modifier.size(uploadIconSize), contentScale = ContentScale.Fit)
                        }

                        Text("Upload", color = Color(0xFFEFE7F6), modifier = Modifier.padding(top = 8.dp))
                        Text("(mp4 file)", color = Color(0xFFB6A9C1), fontSize = 12.sp)

                        // If a file is selected, show filename + play/pause + slider
                        selectedFileUri?.let {
                            Spacer(modifier = Modifier.height(10.dp))
                            Box(modifier = Modifier.fillMaxWidth().background(Color(0xFF372933), RoundedCornerShape(10.dp)).padding(10.dp)) {
                                Row(verticalAlignment = Alignment.CenterVertically, modifier = Modifier.fillMaxWidth()) {
                                    Text(text = selectedFileName ?: it.lastPathSegment ?: "Selected file", color = Color(0xFFEFE7F6),
                                        maxLines = 1, overflow = TextOverflow.Ellipsis, modifier = Modifier.weight(1f))

                                    Spacer(modifier = Modifier.width(8.dp))

                                    // Play/Pause button for main media (same look as jumpscare)
                                    Image(
                                        painter = painterResource(id = if (isPlaying) R.drawable.pause else R.drawable.play),
                                        contentDescription = if (isPlaying) "Pause" else "Play",
                                        modifier = Modifier
                                            .size(playSize)
                                            .clickable(interactionSource = noRipple, indication = null) {
                                                if (!isSoundOn) {
                                                    Toast.makeText(context, "Enable sound to play", Toast.LENGTH_SHORT).show()
                                                    return@clickable
                                                }
                                                mediaPlayer?.let { mp ->
                                                    try {
                                                        if (mp.isPlaying) {
                                                            mp.pause(); isPlaying = false
                                                            prefs.edit().putBoolean("saved_is_playing", false).apply()
                                                        } else {
                                                            mp.start(); isPlaying = true
                                                            prefs.edit().putBoolean("saved_is_playing", true).apply()
                                                        }
                                                    } catch (e: Exception) {
                                                        Toast.makeText(context, "Can't play: ${e.message}", Toast.LENGTH_SHORT).show()
                                                    }
                                                } ?: run {
                                                    // try to prepare and start
                                                    selectedFileUri?.let { u ->
                                                        prepareMediaFromUri(context, u, forJumpscareSound = false)?.let { mp2 ->
                                                            mediaPlayer?.release()
                                                            mediaPlayer = mp2
                                                            try { mp2.start(); isPlaying = true; prefs.edit().putBoolean("saved_is_playing", true).apply() } catch (_: Exception) {}
                                                        }
                                                    }
                                                }
                                            },
                                        contentScale = ContentScale.Fit
                                    )
                                }
                            }

                            Spacer(modifier = Modifier.height(8.dp))

                            val progress = if (durationMs > 0) (currentPositionMs.toFloat() / durationMs.toFloat()).coerceIn(0f, 1f) else 0f
                            Slider(
                                value = if (isSeeking) seekPercent else progress,
                                onValueChange = { value ->
                                    seekPercent = value
                                    isSeeking = true
                                },
                                onValueChangeFinished = {
                                    isSeeking = false
                                    val targetMs = ((seekPercent.coerceIn(0f, 1f)) * (durationMs.coerceAtLeast(1))).toInt()
                                    try {
                                        mediaPlayer?.seekTo(targetMs)
                                        currentPositionMs = targetMs
                                        if (isPlaying) { try { mediaPlayer?.start(); isPlaying = true } catch (_: Exception) {} }
                                    } catch (e: Exception) {
                                        Toast.makeText(context, "Seek failed: ${e.message}", Toast.LENGTH_SHORT).show()
                                    }
                                },
                                modifier = Modifier.fillMaxWidth().height(28.dp),
                                enabled = isSoundOn && (durationMs > 0),
                                colors = SliderDefaults.colors(
                                    thumbColor = if (isSoundOn) Color.White else Color(0xFF7A7A7A),
                                    activeTrackColor = if (isSoundOn) Color.White else Color(0xFF7A7A7A),
                                    inactiveTrackColor = Color(0x66FFFFFF)
                                )
                            )
                        }
                    }
                }

                Spacer(modifier = Modifier.height(sectionSpacing))

                // --------------------
                // JUMPSCARES LABEL + SWITCH (same row)
                // --------------------
                Row(modifier = Modifier.fillMaxWidth().padding(horizontal = 6.dp), verticalAlignment = Alignment.CenterVertically) {
                    Text(text = "Jumpscares (Experimental)", color = Color(0xFFEFE7F6), fontSize = sectionTitleSize, fontWeight = FontWeight.SemiBold)
                    Spacer(modifier = Modifier.weight(1f))
                    Switch(
                        checked = jumpscaresOn,
                        onCheckedChange = { enabled ->
                            jumpscaresOn = enabled
                            prefs.edit().putBoolean("saved_jumpscares_on", jumpscaresOn).apply()
                            if (enabled && isSoundOn) {
                                // disabling sound when jumpscares enabled
                                isSoundOn = false
                                try { mediaPlayer?.pause() } catch (_: Exception) {}
                                isPlaying = false
                                prefs.edit().putBoolean("saved_sound_on", false).apply()
                            }
                            if (!enabled) {
                                releaseJumpscareSoundPlayer()
                                prefs.edit().putBoolean("saved_jumpscare_is_playing", false).apply()
                            }
                        },
                        colors = SwitchDefaults.colors(
                            checkedThumbColor = Color.White, checkedTrackColor = Color(0xFF20C997),
                            uncheckedThumbColor = Color.White, uncheckedTrackColor = Color(0xFF7A7A7A)
                        )
                    )
                }

                Spacer(modifier = Modifier.height(8.dp))

                // --------------------
                // Jumpscare image selector card
                // --------------------
                Box(modifier = Modifier.fillMaxWidth().background(cardColor, RoundedCornerShape(18.dp)).padding(12.dp)) {
                    Row(modifier = Modifier.fillMaxWidth(), verticalAlignment = Alignment.CenterVertically) {
                        Column(modifier = Modifier.width((w * 0.32f).coerceIn(120f, 220f).dp), verticalArrangement = Arrangement.spacedBy(12.dp)) {
                            @Composable
                            fun selectorIcon(index: Int, drawableRes: Int? = null) {
                                Row(verticalAlignment = Alignment.CenterVertically,
                                    modifier = Modifier.fillMaxWidth().clickable {
                                        if (jumpscaresOn) {
                                            jumpscareSelectedIndex = index
                                            prefs.edit().putInt("saved_jumpscare_index", jumpscareSelectedIndex).apply()
                                            if (index == 2 && jumpscareCustomUri == null) openImageLauncher.launch(arrayOf("image/*"))
                                        } else {
                                            Toast.makeText(context, "Enable jumpscares to change images", Toast.LENGTH_SHORT).show()
                                        }
                                    }.padding(4.dp)
                                ) {
                                    Box(modifier = Modifier.size(22.dp).background(if (jumpscareSelectedIndex == index) Color.White else Color.Transparent, shape = CircleShape)
                                        .border(width = 2.dp, color = Color.White, shape = CircleShape))
                                    Spacer(modifier = Modifier.width(10.dp))
                                    if (drawableRes != null) Image(painter = painterResource(id = drawableRes), contentDescription = null, modifier = Modifier.size(34.dp), contentScale = ContentScale.Fit)
                                    else Box(modifier = Modifier.size(34.dp).background(Color(0xFF3C2B3E), shape = RoundedCornerShape(6.dp)), contentAlignment = Alignment.Center) { Text("?", color = Color.White, fontSize = 12.sp) }
                                }
                            }

                            selectorIcon(0, R.drawable.burger)
                            selectorIcon(1, R.drawable.jobapp)

                            // custom image selector
                            Row(verticalAlignment = Alignment.CenterVertically, modifier = Modifier.fillMaxWidth().padding(4.dp).clickable {
                                if (!jumpscaresOn) { Toast.makeText(context, "Enable jumpscares to change images", Toast.LENGTH_SHORT).show(); return@clickable }
                                jumpscareSelectedIndex = 2
                                prefs.edit().putInt("saved_jumpscare_index", jumpscareSelectedIndex).apply()
                                openImageLauncher.launch(arrayOf("image/*"))
                            }) {
                                Box(modifier = Modifier.size(22.dp).background(if (jumpscareSelectedIndex == 2) Color.White else Color.Transparent, shape = CircleShape)
                                    .border(width = 2.dp, color = Color.White, shape = CircleShape))
                                Spacer(modifier = Modifier.width(10.dp))
                                if (jumpscareCustomBitmap != null) Image(bitmap = jumpscareCustomBitmap!!, contentDescription = null, modifier = Modifier.size(34.dp), contentScale = ContentScale.Crop)
                                else Box(modifier = Modifier.size(34.dp).background(Color(0xFF3C2B3E), shape = RoundedCornerShape(6.dp)), contentAlignment = Alignment.Center) { Text("C", color = Color.White, fontSize = 12.sp) }
                            }
                        }

                        Spacer(modifier = Modifier.width(12.dp))

                        Column(modifier = Modifier.weight(1f).height((h * 0.28f).coerceIn(120f, 260f).dp), horizontalAlignment = Alignment.CenterHorizontally, verticalArrangement = Arrangement.Center) {
                            Box(modifier = Modifier.fillMaxWidth().weight(1f).background(Color.Transparent, RoundedCornerShape(6.dp)), contentAlignment = Alignment.Center) {
                                when (jumpscareSelectedIndex) {
                                    0 -> Image(painter = painterResource(id = R.drawable.burger), contentDescription = "burger preview", modifier = Modifier.fillMaxWidth().padding(8.dp), contentScale = ContentScale.Fit)
                                    1 -> Image(painter = painterResource(id = R.drawable.jobapp), contentDescription = "jobapp preview", modifier = Modifier.fillMaxWidth().padding(8.dp), contentScale = ContentScale.Fit)
                                    2 -> if (jumpscareCustomBitmap != null) Image(bitmap = jumpscareCustomBitmap!!, contentDescription = "custom preview", modifier = Modifier.fillMaxWidth().padding(8.dp), contentScale = ContentScale.Fit) else Text("No custom image\nselected", color = Color.White)
                                    else -> Text("", color = Color.Transparent) // exhaustive fallback
                                }
                            }

                            Spacer(modifier = Modifier.height(8.dp))

                            val displayedName = when (jumpscareSelectedIndex) {
                                0 -> "Burger"
                                1 -> "Job Application"
                                2 -> jumpscareCustomUri?.let { resolveDisplayName(it) } ?: "Custom"
                                else -> ""
                            }
                            Text(displayedName, color = Color(0xFFEFE7F6), fontWeight = FontWeight.SemiBold)
                        }
                    }
                }

                Spacer(modifier = Modifier.height(sectionSpacing))

                // --------------------
                // Jumpscare sounds card (preview + interactive slider)
                // --------------------
                Box(modifier = Modifier.fillMaxWidth().background(cardColor, RoundedCornerShape(18.dp)).padding(12.dp)) {
                    Row(modifier = Modifier.fillMaxWidth(), verticalAlignment = Alignment.CenterVertically) {
                        Column(modifier = Modifier.width((w * 0.32f).coerceIn(120f, 220f).dp), verticalArrangement = Arrangement.spacedBy(12.dp)) {
                            @Composable
                            fun soundSelector(index: Int, label: String) {
                                Row(verticalAlignment = Alignment.CenterVertically, modifier = Modifier.fillMaxWidth().clickable {
                                    if (!jumpscaresOn) { Toast.makeText(context, "Enable jumpscares to change sounds", Toast.LENGTH_SHORT).show(); return@clickable }
                                    jumpscareSoundSelectedIndex = index
                                    prefs.edit().putInt("saved_jumpscare_sound_index", index).apply()
                                    when (index) {
                                        0 -> { releaseJumpscareSoundPlayer(); jumpscareSoundPlayer = prepareMediaFromRes(R.raw.scream1, forJumpscareSound = true) }
                                        1 -> { releaseJumpscareSoundPlayer(); jumpscareSoundPlayer = prepareMediaFromRes(R.raw.scream2, forJumpscareSound = true) }
                                        2 -> { releaseJumpscareSoundPlayer() }
                                        else -> { releaseJumpscareSoundPlayer() } // exhaustive
                                    }
                                }.padding(4.dp)) {
                                    Box(modifier = Modifier.size(22.dp).background(if (jumpscareSoundSelectedIndex == index) Color.White else Color.Transparent, shape = CircleShape)
                                        .border(width = 2.dp, color = Color.White, shape = CircleShape))
                                    Spacer(modifier = Modifier.width(10.dp))
                                    Box(modifier = Modifier.height(34.dp).width(78.dp), contentAlignment = Alignment.CenterStart) { Text(label, color = Color(0xFFEFE7F6)) }
                                }
                            }
                            soundSelector(0, "Scream 1")
                            soundSelector(1, "Scream 2")
                            soundSelector(2, "None")
                        }

                        Spacer(modifier = Modifier.width(12.dp))

                        Column(modifier = Modifier.weight(1f).height((h * 0.22f).coerceIn(100f, 180f).dp), horizontalAlignment = Alignment.CenterHorizontally, verticalArrangement = Arrangement.Center) {
                            val previewName = when (jumpscareSoundSelectedIndex) {
                                0 -> "Scream 1"
                                1 -> "Scream 2"
                                else -> "None"
                            }

                            Text(previewName, color = Color(0xFFEFE7F6), fontSize = (w * 0.055f).coerceIn(16f, 26f).sp, fontWeight = FontWeight.Bold)
                            Spacer(modifier = Modifier.height(8.dp))

                            Row(verticalAlignment = Alignment.CenterVertically) {
                                // same play/pause icon as main sound
                                IconButton(onClick = {
                                    if (!jumpscaresOn) { Toast.makeText(context, "Enable jumpscares to preview sounds", Toast.LENGTH_SHORT).show(); return@IconButton }
                                    if (jumpscareSoundSelectedIndex == 2) { Toast.makeText(context, "No sound selected", Toast.LENGTH_SHORT).show(); return@IconButton }
                                    jumpscareSoundPlayer?.let { mp ->
                                        try {
                                            if (mp.isPlaying) {
                                                mp.pause(); jumpscareSoundIsPlaying = false
                                                prefs.edit().putBoolean("saved_jumpscare_is_playing", false).apply()
                                            } else {
                                                mp.start(); jumpscareSoundIsPlaying = true
                                                prefs.edit().putBoolean("saved_jumpscare_is_playing", true).apply()
                                            }
                                        } catch (e: Exception) { Toast.makeText(context, "Playback error: ${e.message}", Toast.LENGTH_SHORT).show() }
                                    } ?: run {
                                        when (jumpscareSoundSelectedIndex) {
                                            0 -> {
                                                releaseJumpscareSoundPlayer()
                                                jumpscareSoundPlayer = prepareMediaFromRes(R.raw.scream1, forJumpscareSound = true)
                                                jumpscareSoundPlayer?.setOnPreparedListener { p -> try { p.start(); jumpscareSoundIsPlaying = true; prefs.edit().putBoolean("saved_jumpscare_is_playing", true).apply() } catch (_: Exception) {} }
                                            }
                                            1 -> {
                                                releaseJumpscareSoundPlayer()
                                                jumpscareSoundPlayer = prepareMediaFromRes(R.raw.scream2, forJumpscareSound = true)
                                                jumpscareSoundPlayer?.setOnPreparedListener { p -> try { p.start(); jumpscareSoundIsPlaying = true; prefs.edit().putBoolean("saved_jumpscare_is_playing", true).apply() } catch (_: Exception) {} }
                                            }
                                            else -> { Toast.makeText(context, "No sound selected", Toast.LENGTH_SHORT).show() }
                                        }
                                    }
                                }) {
                                    Image(painter = painterResource(id = if (jumpscareSoundIsPlaying) R.drawable.pause else R.drawable.play), contentDescription = null, modifier = Modifier.size(playSize))
                                }
                            }

                            Spacer(modifier = Modifier.height(6.dp))

                            // interactive jumpscare slider
                            val jsProgress = if (jumpscareSoundDurationMs > 0) (jumpscareSoundCurrentMs.toFloat() / jumpscareSoundDurationMs.toFloat()).coerceIn(0f, 1f) else 0f
                            var jsSeeking by remember { mutableStateOf(false) }
                            var jsSeekPercent by remember { mutableStateOf(0f) }

                            Slider(
                                value = if (jsSeeking) jsSeekPercent else jsProgress,
                                onValueChange = { value -> jsSeekPercent = value; jsSeeking = true },
                                onValueChangeFinished = {
                                    jsSeeking = false
                                    val targetMs = ((jsSeekPercent.coerceIn(0f,1f)) * (jumpscareSoundDurationMs.coerceAtLeast(1))).toInt()
                                    try {
                                        jumpscareSoundPlayer?.seekTo(targetMs)
                                        jumpscareSoundCurrentMs = targetMs
                                        if (jumpscareSoundIsPlaying) { try { jumpscareSoundPlayer?.start(); jumpscareSoundIsPlaying = true } catch (_: Exception) {} }
                                        prefs.edit().putInt("saved_jumpscare_pos", targetMs).apply()
                                    } catch (e: Exception) {
                                        Toast.makeText(context, "Seek failed: ${e.message}", Toast.LENGTH_SHORT).show()
                                    }
                                },
                                modifier = Modifier.fillMaxWidth().height(28.dp),
                                enabled = jumpscareSoundDurationMs > 0 && jumpscareSoundSelectedIndex != 2 && jumpscaresOn,
                                colors = SliderDefaults.colors(thumbColor = Color.White, activeTrackColor = Color.White, inactiveTrackColor = Color(0x66FFFFFF))
                            )
                        }
                    }
                }

                Spacer(modifier = Modifier.height(sectionSpacing * 1.2f))

                // Save button
                Box(modifier = Modifier.fillMaxWidth().padding(vertical = 16.dp), contentAlignment = Alignment.Center) {
                    Box(modifier = Modifier.fillMaxWidth().height(56.dp).background(saveGradient, RoundedCornerShape(14.dp)).clickable(interactionSource = noRipple, indication = null) {
                        // persist state
                        prefs.edit().putString("saved_message", message).apply()
                        prefs.edit().putBoolean("saved_random_on", randomOn).apply()
                        prefs.edit().putBoolean("saved_sound_on", isSoundOn).apply()
                        prefs.edit().putBoolean("saved_jumpscares_on", jumpscaresOn).apply()
                        prefs.edit().putInt("saved_jumpscare_index", jumpscareSelectedIndex).apply()
                        prefs.edit().putInt("saved_jumpscare_sound_index", jumpscareSoundSelectedIndex).apply()
                        selectedFileUriStr?.let { prefs.edit().putString("saved_video_uri", it).apply() }
                        selectedFileName?.let { prefs.edit().putString("saved_video_name", it).apply() }
                        jumpscareCustomUriStr?.let { prefs.edit().putString("saved_jumpscare_custom_uri", it).apply() }
                        prefs.edit().putBoolean("saved_is_playing", isPlaying).apply()
                        prefs.edit().putBoolean("saved_jumpscare_is_playing", jumpscareSoundIsPlaying).apply()
                        Toast.makeText(context, "Saved", Toast.LENGTH_SHORT).show()
                    }, contentAlignment = Alignment.Center) {
                        Text("Save", color = Color.White, fontWeight = FontWeight.SemiBold)
                    }
                }

                Spacer(modifier = Modifier.height(bottomBarHeight + 20.dp))
            }

            // Hidden bottom layer
            Box(modifier = Modifier.fillMaxWidth().align(Alignment.BottomCenter).navigationBarsPadding().padding(bottom = 0.dp)) {
                Image(painter = painterResource(id = R.drawable.hiddenlayer), contentDescription = null, modifier = Modifier.fillMaxWidth().height(bottomBarHeight + 40.dp), contentScale = ContentScale.FillBounds)
            }

            // Bottom nav: disable click for current route
            val navBackStackEntry by navController.currentBackStackEntryAsState()
            val currentRoute = navBackStackEntry?.destination?.route

            Row(modifier = Modifier.fillMaxWidth().align(Alignment.BottomCenter).navigationBarsPadding().padding(bottom = 12.dp, start = 8.dp, end = 8.dp),
                horizontalArrangement = Arrangement.Start, verticalAlignment = Alignment.CenterVertically) {

                BottomNavItemLocal(resId = R.drawable.houseotlined, label = "Home", iconSize = 32.dp, modifier = Modifier.weight(1f), noRipple = noRipple, enabled = currentRoute != "main") {
                    if (currentRoute != "main") {
                        navController.navigate("main", navOptions {
                            anim { enter = android.R.anim.slide_in_left; exit = android.R.anim.slide_out_right; popEnter = android.R.anim.slide_in_left; popExit = android.R.anim.slide_out_right }
                            launchSingleTop = true
                        })
                    }
                }

                BottomNavItemLocal(resId = R.drawable.msgvoices, label = "Msg & Voices", iconSize = 32.dp, modifier = Modifier.weight(1f), noRipple = noRipple, enabled = currentRoute != "msg_voices") {
                    if (currentRoute != "msg_voices") {
                        navController.navigate("msg_voices", navOptions {
                            anim { enter = android.R.anim.slide_in_left; exit = android.R.anim.slide_out_right; popEnter = android.R.anim.slide_in_left; popExit = android.R.anim.slide_out_right }
                            launchSingleTop = true
                        })
                    }
                }

                BottomNavItemLocal(resId = R.drawable.statsoutline, label = "Statistics", iconSize = 32.dp, modifier = Modifier.weight(1f), noRipple = noRipple, enabled = currentRoute != "statistics") {
                    if (currentRoute != "statistics") {
                        navController.navigate("statistics", navOptions {
                            anim { enter = android.R.anim.slide_in_left; exit = android.R.anim.slide_out_right; popEnter = android.R.anim.slide_in_left; popExit = android.R.anim.slide_out_right }
                            launchSingleTop = true
                        })
                    }
                }

                BottomNavItemLocal(resId = R.drawable.checkboxem, label = "To-do", iconSize = 32.dp, modifier = Modifier.weight(1f), noRipple = noRipple, enabled = currentRoute != "todo") {
                    if (currentRoute != "todo") {
                        navController.navigate("todo", navOptions {
                            anim { enter = android.R.anim.slide_in_left; exit = android.R.anim.slide_out_right; popEnter = android.R.anim.slide_in_left; popExit = android.R.anim.slide_out_right }
                            launchSingleTop = true
                        })
                    }
                }
            }

            // Confirmation dialog for upload
            if (showPermissionDialog) {
                AlertDialog(onDismissRequest = { showPermissionDialog = false },
                    title = { Text("Allow file access?") },
                    text = { Text("This app will open a file picker so you can choose an MP4. We will request read access to the chosen file so audio can be played.") },
                    confirmButton = { TextButton(onClick = { showPermissionDialog = false; openDocumentLauncher.launch(arrayOf("video/mp4")) }) { Text("Continue") } },
                    dismissButton = { TextButton(onClick = { showPermissionDialog = false }) { Text("Cancel") } })
            }
        }
    }
}

/** Local bottom nav item used only in this file */
@Composable
private fun BottomNavItemLocal(
    resId: Int,
    label: String,
    iconSize: Dp,
    modifier: Modifier = Modifier,
    noRipple: MutableInteractionSource,
    enabled: Boolean = true,
    onClick: () -> Unit
) {
    Column(horizontalAlignment = Alignment.CenterHorizontally, verticalArrangement = Arrangement.Center,
        modifier = modifier.then(if (enabled) Modifier.clickable(interactionSource = noRipple, indication = null) { onClick() } else Modifier).padding(vertical = 6.dp)) {
        Image(painter = painterResource(id = resId), contentDescription = label, modifier = Modifier.size(iconSize), contentScale = ContentScale.Fit)
        Spacer(modifier = Modifier.height(6.dp))
        Text(label, color = if (enabled) Color(0xFFCFD7E6) else Color(0xFF6E7580), fontSize = 11.sp)
    }
}
